clone:
  git:
    image: blacklanedevops/drone-git:next

pipeline:
  pull:
    image: yspro/drone-plugin-ecr-fetcher
    pull: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    images:
      - 721041513556.dkr.ecr.eu-central-1.amazonaws.com/aws-secrets-fetcher

  aws_secrets:
    image: 721041513556.dkr.ecr.eu-central-1.amazonaws.com/aws-secrets-fetcher
    aws_secrets:
      - GITHUB_TOKEN: devops/github/blacklane-deploy-token

  test_camunda:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export $(cat .ci-secrets | xargs)
      - cd camunda/v2
      - make gitconfig test

  test_otel:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export $(cat .ci-secrets | xargs)
      - cd otel
      - make gitconfig test

  test_logger:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export $(cat .ci-secrets | xargs)
      - cd logger
      - make gitconfig test

  test_middleware:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export $(cat .ci-secrets | xargs)
      - cd middleware
      - make gitconfig test

  test_probes:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - cd probes
      - make test

  test_tracking:
    image: golang:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - export $(cat .ci-secrets | xargs)
      - cd tracking
      - make gitconfig test

  test_x/events:
    image: docker/compose:alpine-1.29.2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - apk --no-cache add make
      - export $(cat .ci-secrets | xargs)
      - cd x/events
      - make docker-tests

